version: '3.8'

services:
  # Your backend service
  backend:
    build: ./backend
    ports:
      - "8445:8000" # Correct mapping: Host 8445 to Container's Uvicorn 8000
    volumes:
      - ./backend:/app
      - db_data:/app/data
    environment:
      - DATABASE_URL=sqlite:///./data/gardening.db
    command: >
      sh -c "alembic upgrade head &&
             uvicorn main:app --host 0.0.0.0 --port 8000 --reload"
    restart: "unless-stopped"
    networks:
      - garden_net

  # # Your existing frontend service (for production build)
  # frontend_prod:
  #   build:
  #     context: ./frontend
  #     dockerfile: Dockerfile # Refers to your existing Nginx Dockerfile
  #   ports:
  #     - "8444:80" # Nginx serves on port 80, map to 8444 on host
  #   depends_on:
  #     - backend # Frontend depends on backend

  # NEW: Frontend development service
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev # Use the new development Dockerfile
    ports:
      - "8444:8444" # Map Vite's dev server port to the host machine
    environment:
      NODE_ENV: development
      # Set the backend URL for the dev environment specifically for Vite's proxy
      VITE_APP_BACKEND_URL: http://backend:8000
    volumes:
      - ./frontend:/app # Mount your frontend source code for hot reloading
      - /app/node_modules # Anonymous volume to keep container's node_modules isolated
    restart: "on-failure"
    depends_on:
      - backend # Frontend dev needs backend to be up
    networks:
      - garden_net

volumes:
  db_data: # Define the named volume for database persistence

networks:
  garden_net:
    driver: bridge
